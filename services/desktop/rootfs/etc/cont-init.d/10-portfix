#!/usr/bin/with-contenv bash
set -Eeuo pipefail

echo "[10-portfix] Starting port fix and front nginx config generation..."

# Compute ports
NGINX_PORT="${PORT:-3000}"
UPSTREAM_HTTP_PORT="${CUSTOM_PORT:-3002}"

# Log values
echo "[10-portfix] Platform PORT=${PORT:-unset}, using NGINX_PORT=$NGINX_PORT; upstream=$UPSTREAM_HTTP_PORT"

# Ensure config dir
mkdir -p /config/nginx/site-confs

# Generate front conf
cat > /config/nginx/site-confs/desktop-front.conf <<EOF
server {
    listen ${NGINX_PORT} default_server;
    server_name _;
    access_log off;

    # Public health check
    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "ok";
    }

    location = /favicon.ico {
        return 204;
    }

    # WebSocket and HTTP proxy to internal Webtop on ${UPSTREAM_HTTP_PORT}
    location / {
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_pass http://127.0.0.1:${UPSTREAM_HTTP_PORT};
    }
}
EOF

echo "[10-portfix] Wrote /config/nginx/site-confs/desktop-front.conf"
